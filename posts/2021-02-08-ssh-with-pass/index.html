<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <title>erenon.hu</title>
  <meta name="description" content="Short thoughts on C++, Unix and in general, technology">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://erenon.hu/">
  <link rel="alternate" type="application/rss+xml" title="erenon.hu" href="http://erenon.hu/posts/index.xml">
</head>
<body>
  <header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="/">erenon.hu</a>
  </div>
  </header>

  <div class="page-content">
    <div class="wrapper">

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Store SSH key passphrase in password manager</h1><time class="post-meta" datetime="2021-02-08">2021-02-08</time>
  </header>
  <div class="post-content" itemprop="articleBody"><p>The <code>ssh-agent</code> program can be used to manage unlocked SSH keys.
The <code>ssh-add</code> program can be used to add keys to a running <code>ssh-agent</code>.
By default, <code>ssh-add</code> uses TTY to ask for a password,
if the selected key is password protected.</p>
<p>The <a href="https://www.passwordstore.org/">pass</a> program is a password manager that follows the Unix philosophy.
If you want to use <code>pass</code> together with ssh-add, first add the private key
password to it:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ pass insert ssh/identityname_rsa
</code></pre></div><p>Then create this wrapper program <code>/home/user/bin/askpass.sh</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="c1"># $1 ~= Enter passphrase for &#39;.ssh/$KEYNAME&#39;:</span>
<span class="nb">exec</span> /usr/bin/pass <span class="k">$(</span>grep -o <span class="s2">&#34;ssh/[^:&#39;]\+&#34;</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span><span class="k">)</span>
</code></pre></div><p>Export the following variables, e.g: by adding them to you shell rc:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">export</span> <span class="nv">SSH_ASKPASS_REQUIRE</span><span class="o">=</span>force
<span class="nb">export</span> <span class="nv">SSH_ASKPASS</span><span class="o">=</span><span class="s2">&#34;/home/user/bin/askpass.sh&#34;</span>
</code></pre></div><p>Now whenever an SSH key is needed (e.g: for <code>git</code> or <code>ssh</code> client),
<code>ssh-add</code> will turn to <code>pass</code>, giving it the key name to be unlocked,
and in case the gpg key is not unlocked at the moment, <code>pass</code> will
prompt you to enter your password, then safely transmit the key
passphrase to <code>ssh-add</code>, that will add the key to the running <code>ssh-agent</code>.</p>
<p>If git does pop up the gpg unlock dialog, but prints
&ldquo;gpg: decryption failed: No secret key&rdquo; instead,
make sure the <a href="https://www.gnupg.org/documentation/manuals/gnupg/Invoking-GPG_002dAGENT.html">GPG_TTY environment variable</a> is exported:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">export</span> <span class="nv">GPG_TTY</span><span class="o">=</span><span class="nv">$TTY</span>
</code></pre></div><p>If git still does not ask for a password, and no such error is printed:
If the private key is not the default one (e.g: <code>.ssh/id_*</code>), the host-key association
must be configured in <code>.ssh/config</code>, e.g:</p>
<pre><code>Host github.com
  IdentityFile ~/.ssh/your_nondefault_key
</code></pre>
  </div>
</article>


    </div>
  </div>

  <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      
      <div class="footer-col footer-col-3">
        <ul class="social-media-list">
          
          <li>
            Previous post: <a class="prev" href="http://erenon.hu/posts/2021-01-25-freerdp/">Useful FreeRDP flags for good performance</a>
          </li>
          
          
          <li>
            Next post: <a class="next" href="http://erenon.hu/posts/encrypted_backup_rclone/">Automated, encrypted b2 backups with rclone</a>
          </li>
          
        </ul>
      </div>
      
      <div class="footer-col footer-col-1">
        <ul class="social-media-list">
          <li>
            <a href="/posts/index.xml">RSS</a>
          </li>
          <li>
            <a href="https://github.com/erenon" class="username">GitHub</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/users/116273" class="username">StackOverflow</a>
          </li>
          <li>
            <a href="/pages/about">About</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  </footer>
</body>
</html>
